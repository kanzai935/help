---
title: "Webアプリケーション"
description: "AlibabaCloudにおけるWebアプリケーションの実践例を記載します。"
date: 2019-05-13T16:20:40+09:00
weight: 20
draft: false
---

---
## 1. VPCの作成
&nbsp; Alibaba Cloudで、VPCとそれに付随するサブネット(VSwitchと呼ばれる)を作成したいと思います。

### 1-1. サービスの選択
&nbsp; ログイン後のコンソールで、[「Virtual Private Cloud」](https://jp.alibabacloud.com/product/vpc)を選択します。
![WS000000.JPG](./img/VPC/VPC_01.jpeg)

### 1-2. VPCの作成
&nbsp; 「VPCの作成」をクリックします。
![WS000001.JPG](./img/VPC/VPC_02.jpeg)
以下のVPCパラメータを入力します。

- VPC名
- IPv4 CIDR ブロック
![WS000003.JPG](./img/VPC/VPC_03.jpeg)

### 1-3. VSwitchの作成
&nbsp; 続けて同じ画面で、VSwitchと呼ばれるサブネットを作成します。
パラメータとしては以下の3つを入力、アベイラビリティゾーン分ける為、計2つのVSwitchを作成します。

- VPC名
- アベイラビリティゾーン
- IPv4 CIDR ブロック  
![WS000004.JPG](./img/VPC/VPC_04.jpeg)
![WS000005.JPG](./img/VPC/VPC_05.jpeg)
「OK」をクリックした後、「完了」をクリックします。
![WS000007.JPG](./img/VPC/VPC_06.jpeg)

### 1-4. VPCとVSwitchの確認
&nbsp; 「完了」をクリック後、VPCが作成されている事が確認できます。
![WS000008.JPG](./img/VPC/VPC_07.jpeg)
&nbsp; また、VSwitchのダッシュボードより、VSWitchが作成されている事も確認できます。
![WS0001000.JPG](./img/VPC/VPC_08.jpeg)

---
## 2. 仮想マシンの作成
Alibaba Cloudを初めて触るという方向けに仮想マシン作成手順を記します。
AWSを知っている方向けに、AWSとの違いも併せて記します。

### 2-1. ECSサービスの選択
ログイン後のコンソールで[「Elastic Compute Service」](./img/ECS/ECS_00.jpeg)（以下ECS）をクリックします 
![WS000000.JPG](./img/ECS/ECS_01.jpeg)

ECSダッシュボード画面で「インスタンス」をクリックします
　※AWSとの違い: ECSダッシュボード画面では全リージョンのインスタンスの利用状況が表示される
![WS000001.JPG](./img/ECS/ECS_02.jpeg)

### 2-2. リージョン確認
インスタンス画面で初めてリージョンが確認できるので「日本（東京）」である事を確認します
![WS000002.JPG](./img/ECS/ECS_03.jpeg)

### 2-3. インスタンス作成開始
「インスタンスの作成」をクリックします
![WS000003.JPG](./img/ECS/ECS_04.jpeg)

### 2-4. パラメータ入力
以下パラメータを入力して、「次のステップ：ネットワーク」をクリックします

- サブスクリプション（AWSでいうリザーブドインスタンス）か従量課金か
- アベイラビリティゾーン
- インスタンスタイプ
- インスタンスOS
- ルートディスクの種類とサイズ

![WS000005.JPG](./img/ECS/ECS_05.jpeg)
![WS000007.JPG](./img/ECS/ECS_06.jpeg)

以下パラメータを入力して、「次のステップ：システム構成」をクリックします

- 所属するVPCとVSwitch(AWSでいうサブネット)
- パブリックIPの割り当て
- アタッチするセキュリティグループと主要プロトコルの許可設定
![WS000008.JPG](./img/ECS/ECS_07.jpeg)

以下パラメータを入力して、「次のステップ：グループ化」をクリックします

- インスタンスにアクセスする為の秘密鍵もしくはパスワードを指定します  
　※AWSとの違い：デフォルトだと秘密鍵・パスワード共に指定なし  
- コンソール上のインスタンス名と説明、インスタンスOS内部のホスト名を入力します  

![WS000010.JPG](./img/ECS/ECS_08.jpeg)

タグ名とタグ値を入力して、「次のステップ：プレビュー」をクリックします
![WS000011.JPG](./img/ECS/ECS_09.jpeg)

### 2-5. インスタンス作成の完了
「ECS SLAと利用規約に同意します」にチェックを入れて、「インスタンスの作成」をクリックします
![WS000013.JPG](./img/ECS/ECS_10.jpeg)

### 2-6. 作成されたインスタンスの確認
有効と表示されたら、「コンソール」をクリックして、当該インスタンスが作成されている事を確認します
![WS000015.JPG](./img/ECS/ECS_11.jpeg)
![WS0000166.JPG](./img/ECS/ECS_12.jpeg
パブリックIP/EIPを割り当てている場合は、IPアドレスの列にグローバルIPアドレスが表示されます
![WS000009.JPG](./img/ECS/ECS_13.jpeg)

---
## 3. RDS作成手順
RDSコンソールから  MySQL インスタンスを起動し、ECS から MySQL へ接続するまでをご紹介します。

### 3-1. サービスの選択

###  3-1. RDS インスタンスの起動
購入画面は以下の通りです。
リージョン/ゾーン、データベースエンジン、インスタンスタイプ、ストレージ、VPC/VSwitch を選択します。

![WS000009.JPG](./img/RDS/RDS_01.png)
![WS000009.JPG](./img/RDS/RDS_02.png)
![WS000009.JPG](./img/RDS/RDS_03.png)
![WS000009.JPG](./img/RDS/RDS_04.png)
![WS000009.JPG](./img/RDS/RDS_05.png)
![WS000009.JPG](./img/RDS/RDS_06.png)
![WS000009.JPG](./img/RDS/RDS_07.png)
![WS000009.JPG](./img/RDS/RDS_08.png)
![WS000009.JPG](./img/RDS/RDS_09.png)
![WS000009.JPG](./img/RDS/RDS_10.png)
![WS000009.JPG](./img/RDS/RDS_11.png)
![WS000009.JPG](./img/RDS/RDS_12.png)
![WS000009.JPG](./img/RDS/RDS_13.png)
![WS000009.JPG](./img/RDS/RDS_14.png)
![WS000009.JPG](./img/RDS/RDS_15.png)
![WS000009.JPG](./img/RDS/RDS_16.png)
![WS000009.JPG](./img/RDS/RDS_17.png)
![WS000009.JPG](./img/RDS/RDS_18.png)
![WS000009.JPG](./img/RDS/RDS_19.png)
![WS000009.JPG](./img/RDS/RDS_20.png)
![WS000009.JPG](./img/RDS/RDS_21.png)
![WS000009.JPG](./img/RDS/RDS_22.png)
![WS000009.JPG](./img/RDS/RDS_23.png)
![WS000009.JPG](./img/RDS/RDS_24.png)
![WS000009.JPG](./img/RDS/RDS_25.png)
![WS000009.JPG](./img/RDS/RDS_26.png)

## ホワイトリストの更新
RDS インスタンスが立ち上がったので、基本情報を見てみます。
RDS のアドレスとしてイントラネットアドレスと外部アドレスがありますが、どちらも表示されていません。
外部アドレスは不要だとしても、イントラネットアドレス（VPC 内からの接続用アドレス）は必要ですね。

このアドレスを取得するためにはホワイトリストを更新する必要があります。

![WS000009.JPG](./img/RDS/RDS_01.png)

「セキュリティコントロール」のメニューより「ホワイトリスト」を更新します。
デフォルトでは「127.0.0.1」になっているので、接続許可したい接続元のアドレスやセグメントに変更してあげます。

![WS000009.JPG](./img/RDS/RDS_01.png)


この RDS のインスタンスは 10.0.0.0/8 の VPC 内に立てました。ホワイトリストは 「10.0.0.0/8」 に設定して、このセグメント内であればどのインスタンスからでも接続できるようにしてみます。

![WS000009.JPG](./img/RDS/RDS_01.png)


ホワイトリストを更新してあげると、イントラネットアドレスが表示されました。

![WS000009.JPG](./img/RDS/RDS_01.png)

## データベースアカウントの作成
「アカウント管理」メニューにてアカウントを作成します。

![WS000009.JPG](./img/RDS/RDS_01.png)

「testuser」というアカウントにしました。
「許可済みデータベース」は、まだデータベースを作成していなければ選択しなくて構いません。　

![WS000009.JPG](./img/RDS/RDS_01.png)

有効になっています。

![WS000009.JPG](./img/RDS/RDS_01.png)


## ECS からの接続確認
ホワイトリストの更新、データベースアカウントの作成、が終わったので、一旦 ECS から接続確認してみます。

無事接続できました。

![WS000009.JPG](./img/RDS/RDS_01.png)

もし、ホワイトリストで許可されていない場合は、以下のようなエラーになります。

![WS000009.JPG](./img/RDS/RDS_01.png)


## データベースの作成
最後にデータベースを作成します。これもコンソール上から作成可能です。

「testdb」というデータベース名にします。許可するアカウントは先程作った「testuser」です。

![WS000009.JPG](./img/RDS/RDS_01.png)

作成されました。

![WS000009.JPG](./img/RDS/RDS_01.png)

確認してみます。
「testdb」が増えていることが確認できました。

![WS000009.JPG](./img/RDS/RDS_01.png)


以上です。
---
## 4. SLB作成手順
Alibaba Cloudでは、仮想ロードバランサの事を[Server Load Balancer](./img/SLB/SLB_01.jpeg)と呼称しており、その利用手順を記載します。ちなみにSLBの機能は、AWSのCLB、ALB、NLB3つの機能をいい感じに集約しています。

### 4-1. サービスの選択
ログイン後のコンソールで、「Server Load Balancer」をクリックします。
![WS000000.JPG](./img/SLB/SLB_02.jpeg)
### 4-2. ロードバランサの作成
「ロードバランサの作成」をクリックします。
![WS000001.JPG](./img/SLB/SLB_03.jpeg)
ロードバランサのパラメータとして、以下を入力して、「今すぐ購入」をクリックします。

- リージョン
- プライマリーゾーン
- バックアップゾーン
- インスタンス名
- インスタンスタイプ（外部公開/内部公開）
- インスタンススペック
- 個数
![WS000003.JPG](./img/SLB/SLB_04.jpeg)
利用規約に同意して、「有効化」をクリックします。
![WS000004.JPG](./img/SLB/SLB_05.jpeg)

### 4-3. ロードバランサのリスナー設定
先程作成したロードバランサで「リスナーの設定」をクリックします。
![WS000005.JPG](./img/SLB/SLB_06.jpeg)
接続することプロトコルとポート番号（今回はHTTPと80）を入力して、「次へ」をクリックします。
![WS000007.JPG](./img/SLB/SLB_07.jpeg)
### 4-4. ロードバランサのバックエンド設定
VServerグループが選択されている事を確認して、「VServerグループの作成」をクリックします。
![WS000009.JPG](./img/SLB/SLB_08.jpeg)
VServerグループ名を入力して、「追加」をクリックします。
![WS000010.JPG](./img/SLB/SLB_09.jpeg)
既存のECSインスタンスの中から、バックエンドとなるインスタンスにチェックを入れて、「次のステップ：重みとポートの設定」をクリックします。
![WS000012.JPG](./img/SLB/SLB_10.jpeg)
バックエンドがリッスンしているポート番号（80)と、重み（100）を入力して「次へ」をクリックします。
![WS000013.JPG](./img/SLB/SLB_11.jpeg)
### 4-5. ロードバランサのヘルスチェック設定
ヘルスチェックの項目を確認、必要であれば変更して、「次へ」をクリックします。
![WS000014.JPG](./img/SLB/SLB_12.jpeg)
確認画面が表示されるので、「送信」をクリックします。
![WS000015.JPG](./img/SLB/SLB_13.jpeg)
作成が完了したら、「OK」をクリックします。
![WS000017.JPG](./img/SLB/SLB_14.jpeg)
### 4-6. ロードバランサの動作確認
ステータスは実行中であっても、ヘルスチェックが通るまでは利用不可と表示されます
![WS000018.JPG](./img/SLB/SLB_15.jpeg)
ヘルスチェックが正常になったら、バックエンドにアクセス可能です。
![WS000019.JPG](./img/SLB/SLB_16.jpeg)
![WS000021.JPG](./img/SLB/SLB_17.jpeg)

---
## 5. Domain設定手順
### 5-1. Domain設定